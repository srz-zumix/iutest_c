# Test Makefile for GNU make
#
#   make [all]  - makes everything.
#   make TARGET - makes the given target.
#   make test   - makes everything and run.
#   make clean  - removes all files generated by make.


#
# Flags passed to the C++ compiler.
CCFLAGS += -g -Wall -Wextra
CCFLAGS += $(DEFS)

ifdef OUTPUTXML
CCFLAGS +=-DOUTPUTXML
endif

MAKEFILE=GNUmakefile CommonMakefile.in

#
# include
#
include CommonMakefile.in

OBJS   := $(TARGETS:%=%.o)
SRCS   := $(TARGETS:%=%.c)
RUNNER := $(TARGETS:%=run_%)

# House-keeping build targets.

.PHONY: clean default all run test

default: $(TARGETS)

all : clean default test

clean:
	rm -f $(TARGETS) *.o
ifdef OUTPUTXML
	rm -f *.xml
endif

run: test
test: $(RUNNER)

run_% : %
	@echo $<
ifdef OUTPUTXML
	./$< $(RUN_OPTION) --iutest_output=xml:$<.xml
else
	./$< $(RUN_OPTION)
endif

# Builds a sample test.  

ifdef USE_LIB
override CCFLAGS_ += -DIUTEST_C_USE_LIB=1 -L../lib
$(TARGETS) : $(SRCS) $(IUTEST_HEADERS) $(MAKEFILE)
	$(CC) $(CCFLAGS_) $(CCFLAGS) -o $@ $@.c -liutest_c

else

$(TARGETS) : $(SRCS) $(IUTEST_HEADERS) $(MAKEFILE)
	$(CC) $(CCFLAGS_) $(CCFLAGS) -o $@ $@.c

endif
